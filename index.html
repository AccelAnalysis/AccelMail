<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direct Mailer Campaign Launcher</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Map Container adjustments for mobile edge-to-edge */
        #map {
            height: 400px;
            width: 100%;
            z-index: 1;
        }
        
        @media (max-width: 640px) {
            #map {
                height: 50vh; /* Taller on mobile for better interaction */
            }
            .mobile-edge {
                margin-left: -1rem;
                margin-right: -1rem;
                width: calc(100% + 2rem);
                border-radius: 0;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-3xl mx-auto px-4 py-4 flex justify-between items-center">
            <img src="https://img1.wsimg.com/isteam/ip/0815fdc9-aafc-4fe1-99f8-dedc9ba0e23b/blob-f3ca1db.png" alt="Accel Analysis" class="h-12">
        </div>
    </header>

    <div class="max-w-3xl mx-auto px-4 py-8 space-y-8">
        
        <!-- Hero Image -->
        <img src="https://img1.wsimg.com/isteam/ip/0815fdc9-aafc-4fe1-99f8-dedc9ba0e23b/blob-02576cc.png" alt="Campaign Hero" class="w-full rounded-xl shadow-md object-cover h-48 sm:h-64">

        <!-- FORM START -->
        <form id="campaignForm" class="space-y-8">
            
            <!-- SECTION 1: LOCATE MARKET SEGMENTS (Map First) -->
            <section class="bg-white rounded-xl shadow-md overflow-hidden border border-slate-200">
                <div class="p-6 border-b border-slate-100">
                    <h2 class="text-xl font-bold text-slate-800">1. Locate Market Segments</h2>
                    <p class="text-sm text-slate-500 mt-1">Search your target area, place a pin, and define your mailing radius.</p>
                </div>

                <!-- Address Search Bar -->
                <div class="p-4 bg-slate-50 border-b border-slate-200">
                    <div class="flex gap-2">
                        <input type="text" id="addressInput" placeholder="Enter address, city, or zip..." class="flex-1 p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:outline-none shadow-sm" onkeydown="if(event.key === 'Enter'){event.preventDefault(); searchAddress();}">
                        <button type="button" onclick="searchAddress()" class="bg-blue-600 text-white px-4 rounded-lg hover:bg-blue-700 transition shadow-sm font-medium">
                            <i class="fa-solid fa-magnifying-glass"></i> <span class="hidden sm:inline">Search</span>
                        </button>
                    </div>
                    <p id="searchStatus" class="text-xs text-red-500 mt-2 hidden"></p>
                </div>

                <!-- MAP (Edge-to-Edge on Mobile) -->
                <div class="relative mobile-edge">
                    <div id="map"></div>
                    
                    <!-- Map Overlay Controls -->
                    <div class="absolute bottom-4 left-4 right-4 z-[400] bg-white/90 backdrop-blur p-4 rounded-lg shadow-lg border border-slate-200">
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Target Radius: <span id="radiusVal" class="text-blue-600 text-lg">1.0</span> miles</label>
                        <input type="range" min="0.1" max="50" step="0.1" value="1" id="radiusSlider" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                        <div class="flex justify-between text-xs text-slate-400 mt-1">
                            <span>0.1mi</span>
                            <span>50mi</span>
                        </div>
                    </div>
                </div>

                <!-- Hidden Inputs for Map Data -->
                <input type="hidden" name="target_lat" id="target_lat">
                <input type="hidden" name="target_lng" id="target_lng">
                <input type="hidden" name="target_radius" id="target_radius">
                <input type="hidden" name="locations_json" id="locations_json">

                <!-- Selection Criteria TABS -->
                <div class="p-6">
                    <h3 class="font-semibold text-slate-700 mb-4">Selection Criteria</h3>
                    
                    <!-- Tab Navigation -->
                    <div class="flex rounded-lg bg-slate-100 p-1 mb-6">
                        <button type="button" onclick="switchTab('survey')" id="tab-survey-btn" class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all bg-white text-blue-600 shadow-sm">Target Market Survey</button>
                        <button type="button" onclick="switchTab('expert')" id="tab-expert-btn" class="flex-1 py-2 px-4 rounded-md text-sm font-medium text-slate-500 hover:text-slate-700 transition-all">Consult an Expert</button>
                    </div>

                    <!-- Tab Content: Survey -->
                    <div id="tab-survey" class="text-center py-6 border-2 border-dashed border-slate-200 rounded-lg">
                        <i class="fa-solid fa-clipboard-list text-4xl text-blue-200 mb-3"></i>
                        <p class="text-slate-600 mb-4">Know your audience? Fill out our detailed survey.</p>
                        <a href="target_market_survey.html" target="_blank" class="inline-flex items-center text-blue-600 font-semibold hover:underline">
                            Open Target Market Survey <i class="fa-solid fa-arrow-up-right-from-square ml-2 text-xs"></i>
                        </a>
                        <input type="hidden" name="selection_method" id="selection_method" value="Survey">
                        <input type="hidden" name="survey_data" id="survey_data">
                    </div>

                    <!-- Tab Content: Expert -->
                    <div id="tab-expert" class="hidden text-center py-6 border-2 border-dashed border-slate-200 rounded-lg">
                        <i class="fa-solid fa-calendar-check text-4xl text-teal-200 mb-3"></i>
                        <p class="text-slate-600 mb-4">Unsure who to target? Schedule a call with our segmentation experts.</p>
                        <a href="https://outlook.office.com/book/AccelAnalysis1@NETORGFT15328873.onmicrosoft.com/s/LUKxf3eKv0igPKL4Tbkb-A2?ismsaljsauthenabled" target="_blank" class="inline-block bg-teal-600 text-white py-2 px-6 rounded-lg font-medium hover:bg-teal-700 transition shadow-sm">
                            Schedule Consultation
                        </a>
                    </div>
                </div>
            </section>

            <!-- SECTION 2: CAMPAIGN DETAILS (Send Greetings & Thank You's) -->
            <section class="bg-white rounded-xl shadow-md border border-slate-200 p-6">
                <h2 class="text-xl font-bold text-slate-800 mb-6">2. Send Greetings & Thank You's</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Campaign Name -->
                    <div class="col-span-1 md:col-span-2">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Campaign Name / Purpose</label>
                        <input type="text" name="campaign_name" placeholder="e.g. Summer Sale, Client Thank You, New Location" class="w-full p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    </div>

                    <!-- Mailer Type -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Mailer Type</label>
                        <select name="mailer_type" class="w-full p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:outline-none bg-white">
                            <option value="" disabled selected>Select format...</option>
                            <option value="Postcard 4x6">Standard Postcard (4x6)</option>
                            <option value="Postcard 6x9">Jumbo Postcard (6x9)</option>
                            <option value="Letter">Letter in Envelope</option>
                            <option value="Brochure">Tri-fold Brochure</option>
                            <option value="Catalog">Catalog</option>
                        </select>
                    </div>

                    <!-- Estimated Quantity -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Approximate Quantity (Leave blank to let Target Market Determine)</label>
                        <input type="number" name="quantity" placeholder="e.g. 5000" class="w-full p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    </div>

                    <!-- Target Date -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Target Drop Date</label>
                        <input type="date" name="target_date" class="w-full p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    </div>
                     <!-- Budget -->
                     <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Estimated Budget (Leave blank to let Target Market Determine)</label>
                        <div class="relative">
                            <span class="absolute left-3 top-3 text-slate-500">$</span>
                            <input type="number" name="budget" placeholder="0.00" class="w-full p-3 pl-7 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        </div>
                    </div>
                </div>
            </section>

            <!-- SECTION 3: CONTACT INFO -->
            <section class="bg-white rounded-xl shadow-md border border-slate-200 p-6">
                <h2 class="text-xl font-bold text-slate-800 mb-6">3. Contact Info</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    
                    <!-- Name -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Full Name *</label>
                        <input type="text" name="full_name" required class="w-full p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    </div>

                    <!-- Company -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Company / Organization</label>
                        <input type="text" name="company" class="w-full p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    </div>

                    <!-- Email -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Email Address *</label>
                        <input type="email" name="email" required class="w-full p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    </div>

                    <!-- Phone -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Phone Number</label>
                        <input type="tel" name="phone" class="w-full p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    </div>

                    <!-- Follow Up Method (Moved from Section 4) -->
                    <div class="col-span-1 md:col-span-2">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Preferred Follow-up Method</label>
                        <select name="follow_up_method" id="follow_up_method" class="w-full p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:outline-none bg-white" onchange="toggleFollowUpOptions()">
                            <option value="Email">Email me</option>
                            <option value="Phone Call">Call me</option>
                            <option value="Text Message">Text me</option>
                            <option value="Virtual Meeting">Virtual Meeting</option>
                            <option value="No Preference">No Preference</option>
                        </select>
                    </div>

                    <!-- Call Me Additional Options -->
                    <div id="callMeOptions" class="col-span-1 md:col-span-2 hidden grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-slate-50 rounded-lg border border-slate-200">
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-500 mb-2">Best Time to Call</label>
                            <div class="space-y-2">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" name="call_time_morning" value="Morning" class="rounded text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-slate-700">Morning</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" name="call_time_afternoon" value="Afternoon" class="rounded text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-slate-700">Afternoon</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" name="call_time_evening" value="Evening" class="rounded text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-slate-700">Evening</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-500 mb-2">Best Days (Week Days)</label>
                            <div class="grid grid-cols-2 gap-2">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" name="call_day_mon" value="Monday" class="rounded text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-slate-700">Mon</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" name="call_day_tue" value="Tuesday" class="rounded text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-slate-700">Tue</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" name="call_day_wed" value="Wednesday" class="rounded text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-slate-700">Wed</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" name="call_day_thu" value="Thursday" class="rounded text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-slate-700">Thu</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" name="call_day_fri" value="Friday" class="rounded text-blue-600 focus:ring-blue-500">
                                    <span class="text-sm text-slate-700">Fri</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="col-span-1 md:col-span-2">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Additional Notes / Special Instructions</label>
                        <textarea name="notes" rows="4" class="w-full p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Tell us more about your goals..."></textarea>
                    </div>
                </div>
            </section>

            <!-- SUBMIT BUTTON -->
            <div class="sticky bottom-4 z-40">
                <button type="submit" id="submitBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-xl shadow-xl transition transform active:scale-95 flex items-center justify-center gap-2">
                    <span>Start My Campaign</span>
                    <i class="fa-solid fa-arrow-right"></i>
                </button>
            </div>
            
        </form>

        <p class="text-center text-xs text-slate-400 pb-8">&copy; 2025 Accel Analysis. All rights reserved.</p>

    </div>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        // --- GLOBAL SETTINGS ---
        const BOOKING_URL = "https://outlook.office.com/book/AccelAnalysis1@NETORGFT15328873.onmicrosoft.com/s/LUKxf3eKv0igPKL4Tbkb-A2?ismsaljsauthenabled"; // UPDATE THIS LINK
        const GOOGLE_SCRIPT_URL = "INSERT_YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE";

        // --- MAP STATE & LOGIC ---
        let locations = []; // Array of location objects
        let activeLocationId = null;
        let nextId = 1;

        // 1. Initialize Map
        const map = L.map('map').setView([36.8460, -76.2881], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // 2. Add Location Function
        function addLocation(lat, lng, name = "") {
            const id = nextId++;
            // Default spacing from current slider value
            const currentSpacing = parseFloat(document.getElementById('radiusSlider').value);
            
            const marker = L.marker([lat, lng], {draggable: true}).addTo(map);
            
            const loc = {
                id: id,
                lat: lat,
                lng: lng,
                name: name || `Location ${id}`,
                ringCount: 1,
                radiusSpacing: currentSpacing, // miles
                marker: marker,
                circles: []
            };

            locations.push(loc);
            
            // Render initial graphics
            renderCircles(loc);
            updatePopup(loc);
            
            // Set as active
            setActiveLocation(id);

            // Events
            marker.on('click', () => setActiveLocation(id));
            marker.on('dragstart', () => setActiveLocation(id));
            marker.on('drag', (e) => {
                const newPos = e.target.getLatLng();
                loc.lat = newPos.lat;
                loc.lng = newPos.lng;
                renderCircles(loc);
                updateHiddenJson();
            });

            updateHiddenJson();
            return loc;
        }

        // 3. Set Active Location
        function setActiveLocation(id) {
            activeLocationId = id;
            const loc = locations.find(l => l.id === id);
            if (!loc) return;

            // Sync Slider to this location's spacing
            const slider = document.getElementById('radiusSlider');
            slider.value = loc.radiusSpacing;
            document.getElementById('radiusVal').textContent = loc.radiusSpacing.toFixed(1);

            // Open popup to show it's selected (optional, but good for UX)
            loc.marker.openPopup();
        }

        // 4. Render Circles
        function renderCircles(loc) {
            // Remove existing circles
            loc.circles.forEach(c => map.removeLayer(c));
            loc.circles = [];

            const milesToMeters = 1609.34;
            
            for (let i = 1; i <= loc.ringCount; i++) {
                const radiusMeters = loc.radiusSpacing * i * milesToMeters;
                // Opacity decreases slightly for outer rings
                const opacity = Math.max(0.1, 0.3 - (i * 0.05));
                
                const circle = L.circle([loc.lat, loc.lng], {
                    color: '#2563eb',
                    fillColor: '#3b82f6',
                    fillOpacity: opacity,
                    weight: 1,
                    radius: radiusMeters,
                    interactive: false // Click through to map/marker
                }).addTo(map);
                loc.circles.push(circle);
            }
        }

        // 5. Update Popup Content
        function updatePopup(loc) {
            const div = document.createElement('div');
            div.className = "p-1 min-w-[220px]";
            
            // We use inline onchange handlers calling window-scoped functions
            div.innerHTML = `
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Label</label>
                        <input type="text" class="w-full border border-slate-300 rounded px-2 py-1 text-sm focus:border-blue-500 outline-none" 
                               value="${loc.name}" 
                               onchange="window.updateLocName(${loc.id}, this.value)">
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="block text-xs font-bold text-slate-500 uppercase">Radius Rings</label>
                            <span class="text-xs font-mono bg-slate-100 px-1 rounded" id="ringCountVal-${loc.id}">${loc.ringCount}</span>
                        </div>
                        <input type="range" min="1" max="5" step="1" value="${loc.ringCount}" 
                               class="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                               oninput="window.updateLocRings(${loc.id}, this.value)">
                    </div>
                    <div class="pt-2 border-t border-slate-100 flex justify-end">
                        <button type="button" onclick="window.deleteLocation(${loc.id})" class="text-xs text-red-500 hover:text-red-700 font-medium flex items-center gap-1">
                            <i class="fa-solid fa-trash"></i> Delete Marker
                        </button>
                    </div>
                </div>
            `;
            
            loc.marker.bindPopup(div);
        }

        // 6. Global Window Handlers for Popup Interactions
        window.updateLocName = (id, val) => {
            const loc = locations.find(l => l.id === id);
            if(loc) { loc.name = val; updateHiddenJson(); }
        };

        window.updateLocRings = (id, val) => {
            const loc = locations.find(l => l.id === id);
            if(loc) {
                loc.ringCount = parseInt(val);
                const display = document.getElementById(`ringCountVal-${id}`);
                if(display) display.textContent = loc.ringCount;
                renderCircles(loc);
                updateHiddenJson();
            }
        };

        window.deleteLocation = (id) => {
            const idx = locations.findIndex(l => l.id === id);
            if (idx > -1) {
                const loc = locations[idx];
                map.removeLayer(loc.marker);
                loc.circles.forEach(c => map.removeLayer(c));
                locations.splice(idx, 1);
                
                // If we deleted the active one, select another if available
                if (activeLocationId === id) {
                    activeLocationId = locations.length > 0 ? locations[locations.length - 1].id : null;
                    if(activeLocationId) setActiveLocation(activeLocationId);
                }
                updateHiddenJson();
            }
        };

        // 7. Update Hidden JSON & Legacy Inputs
        function updateHiddenJson() {
             const data = locations.map(l => ({
                 lat: l.lat,
                 lng: l.lng,
                 name: l.name,
                 rings: l.ringCount,
                 spacing: l.radiusSpacing
             }));
             document.getElementById('locations_json').value = JSON.stringify(data);
             
             // Backwards compatibility for single-location expectations (use first location)
             if (locations.length > 0) {
                 const p = locations[0];
                 document.getElementById('target_lat').value = p.lat.toFixed(6);
                 document.getElementById('target_lng').value = p.lng.toFixed(6);
                 document.getElementById('target_radius').value = p.radiusSpacing;
             } else {
                 document.getElementById('target_lat').value = "";
                 document.getElementById('target_lng').value = "";
                 document.getElementById('target_radius').value = "";
             }
        }

        // 8. Slider Event (Controls Active Location Spacing)
        document.getElementById('radiusSlider').addEventListener('input', function(e) {
            const miles = parseFloat(e.target.value);
            document.getElementById('radiusVal').textContent = miles.toFixed(1);
            
            if (activeLocationId) {
                const loc = locations.find(l => l.id === activeLocationId);
                if (loc) {
                    loc.radiusSpacing = miles;
                    renderCircles(loc);
                    updateHiddenJson();
                }
            }
        });

        // 9. Initial Setup
        // Add a default starting location
        addLocation(36.8460, -76.2881, "500 E Main St, Norfolk, VA 23510");

        // --- SEARCH FUNCTION ---
        async function searchAddress() {
            const query = document.getElementById('addressInput').value;
            const statusMsg = document.getElementById('searchStatus');
            
            if (!query) return;

            statusMsg.textContent = "Searching...";
            statusMsg.classList.remove('hidden', 'text-red-500');
            statusMsg.classList.add('text-blue-500');

            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);
                    
                    // Move map to new location
                    map.flyTo([lat, lon], 13);
                    
                    // ADD new marker instead of moving old one
                    addLocation(lat, lon, query);
                    
                    statusMsg.classList.add('hidden');
                    document.getElementById('addressInput').value = ""; // Clear input
                } else {
                    statusMsg.textContent = "Address not found. Try again.";
                    statusMsg.classList.remove('hidden', 'text-blue-500');
                    statusMsg.classList.add('text-red-500');
                }
            } catch (error) {
                console.error("Search error:", error);
                statusMsg.textContent = "Error connecting to map service.";
            }
        }

        // --- UI LOGIC ---
        // Listen for Survey Completion
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'SURVEY_COMPLETE') {
                console.log("Survey Data Received", event.data.data);
                
                // 1. Store Data
                const input = document.getElementById('survey_data');
                if (input) {
                    input.value = JSON.stringify(event.data.data);
                }

                // 2. Update UI
                const container = document.getElementById('tab-survey');
                if (container) {
                    container.classList.remove('border-dashed');
                    container.classList.add('border-solid', 'bg-blue-50', 'border-blue-200');
                    container.innerHTML = `
                        <div class="animate-bounce-in">
                            <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-3 text-2xl">
                                <i class="fa-solid fa-check"></i>
                            </div>
                            <h3 class="text-lg font-bold text-slate-800 mb-1">Survey Completed!</h3>
                            <p class="text-sm text-slate-600 mb-4">Your target market profile has been attached.</p>
                            
                            <div class="flex justify-center gap-3">
                                <button type="button" onclick="window.open('target_market_survey.html', '_blank')" class="text-xs text-blue-600 font-medium hover:underline">
                                    Redo Survey
                                </button>
                            </div>
                            
                            <!-- Maintain Hidden Inputs -->
                            <input type="hidden" name="selection_method" id="selection_method" value="Survey">
                            <input type="hidden" name="survey_data" id="survey_data" value='${JSON.stringify(event.data.data).replace(/'/g, "&#39;")}'>
                        </div>
                    `;
                }
            }
        });

        // 
        // Tab Switching
        function switchTab(tabName) {
            const surveyTab = document.getElementById('tab-survey');
            const expertTab = document.getElementById('tab-expert');
            const surveyBtn = document.getElementById('tab-survey-btn');
            const expertBtn = document.getElementById('tab-expert-btn');
            const hiddenInput = document.getElementById('selection_method');

            if (tabName === 'survey') {
                surveyTab.classList.remove('hidden');
                expertTab.classList.add('hidden');
                surveyBtn.classList.add('bg-white', 'text-blue-600', 'shadow-sm');
                surveyBtn.classList.remove('text-slate-500');
                expertBtn.classList.remove('bg-white', 'text-blue-600', 'shadow-sm');
                expertBtn.classList.add('text-slate-500');
                hiddenInput.value = "Survey";
            } else {
                surveyTab.classList.add('hidden');
                expertTab.classList.remove('hidden');
                expertBtn.classList.add('bg-white', 'text-blue-600', 'shadow-sm');
                expertBtn.classList.remove('text-slate-500');
                surveyBtn.classList.remove('bg-white', 'text-blue-600', 'shadow-sm');
                surveyBtn.classList.add('text-slate-500');
                hiddenInput.value = "Expert Consultation";
            }
        }

        // Toggle Follow Up Options
        function toggleFollowUpOptions() {
            const method = document.getElementById('follow_up_method').value;
            const callOptions = document.getElementById('callMeOptions');
            
            if (method === 'Phone Call') {
                callOptions.classList.remove('hidden');
                callOptions.classList.add('grid');
            } else {
                callOptions.classList.add('hidden');
                callOptions.classList.remove('grid');
            }
        }

        // --- FORM SUBMISSION ---
        document.getElementById('campaignForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (GOOGLE_SCRIPT_URL === "INSERT_YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE") {
                alert("Please configure the Google Script URL in the code.");
                return;
            }

            const btn = document.getElementById('submitBtn');
            const originalText = btn.innerHTML;
            const method = document.getElementById('follow_up_method').value;
            
            // Loading State
            btn.innerHTML = '<div class="loader"></div>';
            btn.disabled = true;
            btn.classList.add('opacity-75', 'cursor-not-allowed');

            const formData = new FormData(this);
            
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                // Success Handling
                if (method === 'Virtual Meeting') {
                    // Redirect to Booking
                    window.location.href = BOOKING_URL;
                } else {
                    alert("Success! Your campaign request has been started.");
                    btn.innerHTML = 'Submitted <i class="fa-solid fa-check ml-2"></i>';
                    btn.classList.replace('bg-blue-600', 'bg-green-600');
                }
            })
            .catch(error => {
                console.error('Error!', error.message);
                // Even if CORS fails, we often assume success in these simple demos, 
                // but for robust logic we should check.
                if (method === 'Virtual Meeting') {
                    window.location.href = BOOKING_URL;
                } else {
                    alert("Request sent! We will contact you shortly.");
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    btn.classList.remove('opacity-75', 'cursor-not-allowed');
                }
            });
        });
    </script>
</body>
</html>
